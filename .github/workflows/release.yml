name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.2)"
        required: true
        type: string
      dry_run:
        description: "Dry run (don't actually publish)"
        required: false
        default: false
        type: boolean
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@stable
      
      - uses: Swatinem/rust-cache@v2
      
      - name: Validate build
        run: cargo build --workspace --all-features --locked
      
      - name: Run tests
        run: cargo test --workspace --all-features --locked
      
      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  publish:
    runs-on: ubuntu-latest
    needs: validate
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@stable
      
      - uses: Swatinem/rust-cache@v2
      
      - name: Publish crates (ordered)
        run: |
          set -e
          
          DRY_RUN="${{ inputs.dry_run }}"
          if [ "$DRY_RUN" = "true" ]; then
            FLAGS="--dry-run"
            echo "üîç DRY RUN MODE"
          else
            FLAGS=""
            echo "üöÄ PUBLISHING MODE"
          fi
          
          publish() {
            echo "üì¶ Publishing $1..."
            (cd "crates/$1" && cargo publish --no-verify $FLAGS) || {
              echo "‚ö†Ô∏è  $1 may already be published, continuing..."
            }
            sleep 30  # Wait for crates.io index update
          }
          
          # Layer 0: No internal dependencies
          publish json_atomic
          publish logline-core
          
          # Layer 1: Depends on Layer 0
          publish lllv-core
          publish tdln-ast
          publish atomic-types
          
          # Layer 2: Depends on Layer 1
          publish lllv-index
          publish tdln-proof
          publish atomic-crypto
          
          # Layer 3: Depends on Layer 2
          publish tdln-compiler
          publish atomic-codec
          
          # Layer 4: Depends on Layer 3
          publish tdln-gate
          publish ubl-ledger
          
          # Layer 5: Depends on Layer 4
          publish tdln-brain
          publish atomic-sirp
          
          # Layer 6: Depends on Layer 5
          publish atomic-runtime
          publish ubl-mcp
          
          # Layer 7: Top-level
          publish ubl-office
          
          echo "‚úÖ All crates published!"

  create-release:
    runs-on: ubuntu-latest
    needs: publish
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## LogLine Workspace ${{ github.ref_name }}
            
            ### Crates Published
            - `json_atomic`
            - `logline-core`
            - `lllv-core`
            - `lllv-index`
            - `tdln-*` family
            - `atomic-*` family
            - `ubl-*` family
            
            See [crates.io](https://crates.io/search?q=logline) for all published crates.
